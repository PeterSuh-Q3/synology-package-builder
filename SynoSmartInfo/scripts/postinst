#!/bin/bash

PKG_NAME=$(basename "$SYNOPKG_PKGDEST")
TARGET_DIR="/var/packages/$PKG_NAME/target"
UI_DIR="$TARGET_DIR/ui"
VAR_DIR="/var/packages/$PKG_NAME/var"

# Log function
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$VAR_DIR/install.log" 2>/dev/null || echo "$1"
}

log_message "Post-installation starting for package: $PKG_NAME"
log_message "Package destination: $SYNOPKG_PKGDEST"
log_message "Target directory: $TARGET_DIR"

# Create VAR directory
if mkdir -p "$VAR_DIR"; then
    log_message "VAR_DIR created or already exists: $VAR_DIR"
else
    log_message "Failed to create VAR_DIR: $VAR_DIR"
    exit 1
fi

log_message "Post-installation started"

# Create symbolic link for UI
if ln -sf "/var/packages/$PKG_NAME/target/ui" "/usr/syno/synoman/webman/3rdparty/$PKG_NAME" 2>/dev/null; then
    log_message "Created web interface symlink"
else
    log_message "Warning: Failed to create web interface symlink"
fi

# Create and set permission for general log file
if touch "$VAR_DIR/$PKG_NAME.log" 2>/dev/null && chmod 644 "$VAR_DIR/$PKG_NAME.log"; then
    log_message "Log file created and permissions set"
else
    log_message "Warning: Failed to create or set permissions for log file"
fi

log_message "Post-installation completed successfully"

PKG_PATH="$TARGET_DIR"
UI_CGI="$PKG_PATH/ui/smart_result.cgi"
CGI_BIN="$PKG_PATH/cgi-bin"
CGI_BIN_CGI="$CGI_BIN/smart_result.cgi"

# Create cgi-bin directory if it doesn't exist
if [ ! -d "$CGI_BIN" ]; then
    log_message "Creating directory: $CGI_BIN"
    if mkdir -p "$CGI_BIN"; then
        log_message "Directory created: $CGI_BIN"
    else
        log_message "Failed to create $CGI_BIN"
        exit 1
    fi
else
    log_message "Directory already exists: $CGI_BIN"
fi

# Move the smart_result.cgi from ui to cgi-bin directory
if [ -f "$UI_CGI" ]; then
    log_message "Moving $UI_CGI to $CGI_BIN_CGI"
    if mv -f "$UI_CGI" "$CGI_BIN_CGI"; then
        log_message "Successfully moved $UI_CGI to $CGI_BIN_CGI"
    else
        log_message "Failed to move $UI_CGI"
        exit 1
    fi
else
    log_message "File $UI_CGI does not exist, nothing to move"
fi

WEB_CGI_DIR="/var/services/web/Synosmartinfo/cgi-bin"
WEB_CGI="$WEB_CGI_DIR/smart_result.cgi"

mkdir -p "$WEB_CGI_DIR"
# 심볼릭 링크 생성 (이미 존재하면 덮어쓰기)
ln -sf "$CGI_BIN_CGI" "$WEB_CGI"

# Set correct permissions
log_message "Setting executable permission to $CGI_BIN_CGI, $WEB_CGI"
if chmod 755 "$CGI_BIN_CGI" "$WEB_CGI"; then
    log_message "Permission set to 755 for $CGI_BIN_CGI"
else
    log_message "Failed to set permissions for $CGI_BIN_CGI"
    exit 1
fi

log_message "Done."

exit 0

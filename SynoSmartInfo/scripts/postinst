#!/bin/bash

PKG_NAME=$(basename "$SYNOPKG_PKGDEST")
TARGET_DIR="/var/packages/$PKG_NAME/target"
UI_DIR="$TARGET_DIR/ui"
VAR_DIR="/var/packages/$PKG_NAME/var"

# Log function
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$VAR_DIR/install.log" 2>/dev/null || echo "$1"
}

log_message "Post-installation starting for package: $PKG_NAME"

# Create VAR directory
if mkdir -p "$VAR_DIR"; then
    log_message "VAR_DIR created or already exists: $VAR_DIR"
else
    log_message "Failed to create VAR_DIR: $VAR_DIR"
    exit 1
fi

# Create symbolic link for UI
if ln -sf "/var/packages/$PKG_NAME/target/ui" "/usr/syno/synoman/webman/3rdparty/$PKG_NAME" 2>/dev/null; then
    log_message "Created web interface symlink"
else
    log_message "Warning: Failed to create web interface symlink"
fi

# Create result directory in webman (for static file serving)
RESULT_DIR="/usr/syno/synoman/webman/3rdparty/$PKG_NAME/result"
if mkdir -p "$RESULT_DIR"; then
    log_message "Created result directory: $RESULT_DIR"
    chmod 755 "$RESULT_DIR"
else
    log_message "Failed to create result directory: $RESULT_DIR"
fi

# Set execute permissions for scripts
BIN_DIR="$TARGET_DIR/bin"
chmod +x "$BIN_DIR/syno_smart_info.sh" 2>/dev/null
chmod +x "$BIN_DIR/generate_smart_result.sh" 2>/dev/null

# Set execute permissions for API CGI
chmod +x "$UI_DIR/api.cgi" 2>/dev/null
log_message "Set execute permissions for api.cgi"

# Generate initial SMART result
GENERATE_SCRIPT="$BIN_DIR/generate_smart_result.sh"
if [ -f "$GENERATE_SCRIPT" ]; then
    "$GENERATE_SCRIPT" 2>/dev/null &
    log_message "Started initial SMART result generation"
fi

SUDOERS_SRC="$UI_DIR/synosmartinfo"
SUDOERS_DEST="/etc/sudoers.d/synosmartinfo"

if [ -f "$SUDOERS_SRC" ]; then
    cp -vf "$SUDOERS_SRC" "$SUDOERS_DEST" 2>/dev/null
    if [ "$?" -eq 0 ]; then
        log_message "Copied sudoers file to /etc/sudoers.d"
        chmod 0440 "$SUDOERS_DEST" 2>/dev/null
        log_message "Set permissions 0440 for sudoers file"
    else
        log_message "Warning: Failed to copy sudoers file to /etc/sudoers.d"
        # 복사 실패여도 계속 진행 여부 판단 가능
        # exit 1
    fi
else
    log_message "Warning: sudoers source file not found: $SUDOERS_SRC"
    # exit 1
fi

log_message "Post-installation completed successfully"
exit 0

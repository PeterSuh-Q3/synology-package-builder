#!/bin/bash

PKG_NAME=$(basename "$SYNOPKG_PKGDEST")
TARGET_DIR="/var/packages/$PKG_NAME/target"
BIN_DIR="$TARGET_DIR/bin"
UI_DIR="$TARGET_DIR/ui"
VAR_DIR="/var/packages/$PKG_NAME/var"

echo "Post-installation starting for package: $PKG_NAME"
echo "Package destination: $SYNOPKG_PKGDEST"
echo "Target directory: $TARGET_DIR"

mkdir -p "$VAR_DIR" || { echo "Failed to create VAR_DIR: $VAR_DIR"; exit 1; }

# 로그 함수
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$VAR_DIR/install.log" 2>/dev/null || echo "$1"
}

log_message "Post-installation started"

# 심볼릭 링크 생성 (필요 시만)
if ln -sf "/var/packages/$PKG_NAME/target/ui" "/usr/syno/synoman/webman/3rdparty/$PKG_NAME" 2>/dev/null; then
    log_message "Created web interface symlink"
else
    log_message "Warning: Failed to create web interface symlink"
fi

# 로그 파일 생성 및 권한 설정
touch "$VAR_DIR/$PKG_NAME.log" 2>/dev/null && \
chmod 644 "$VAR_DIR/$PKG_NAME.log" 2>/dev/null && \
log_message "Created and configured log file"

# flask 설치
# 로그 메시지 함수는 이미 정의되었다고 가정

# Python3, pip3 위치 확인
PYTHON_BIN=$(command -v python3)

if [ -z "$PYTHON_BIN" ]; then
    log_message "python3 command not found"
    exit 1
fi

# Python ensurepip
log_message "Starting python3 -m ensurepip"
if sudo $PYTHON_BIN -m ensurepip >> "$VAR_DIR/install.log" 2>&1; then
    log_message "python3 -m ensurepip succeeded"
else
    log_message "python3 -m ensurepip failed"
    exit 1
fi

# pip 업그레이드 or 설치
log_message "Starting pip3 install --upgrade pip"
if sudo $PIP_BIN -m pip install --upgrade pip >> "$VAR_DIR/install.log" 2>&1; then
    log_message "pip3 install --upgrade pip succeeded"
else
    log_message "pip3 install --upgrade pip failed"
    exit 1
fi

PIP_BIN=$(command -v pip3)
if [ -z "$PIP_BIN" ]; then
    log_message "pip3 command not found"
    exit 1
fi

# flask 설치
log_message "Starting pip3 install flask"
if sudo $PIP_BIN install flask >> "$VAR_DIR/install.log" 2>&1; then
    log_message "pip3 install flask succeeded"
else
    log_message "pip3 install flask failed"
    exit 1
fi

# express 설치
mkdir -p "$UI_DIR" || { log_message "Failed to create UI_DIR"; exit 1; }
cd "$UI_DIR" || { log_message "Failed to cd into UI_DIR"; exit 1; }
NPM_BIN=$(command -v npm)
if [ -z "$NPM_BIN" ]; then
    log_message "npm command not found"
    exit 1
fi
log_message "Starting npm install express"
if $NPM_BIN install express >> "$VAR_DIR/install.log" 2>&1; then
    log_message "npm install express succeeded"
else
    log_message "npm install express failed"
    exit 1
fi

log_message "Post-installation completed successfully"
echo "Post-installation completed successfully"

exit 0

#!/bin/bash

PKG_NAME=$(basename "$SYNOPKG_PKGDEST")
TARGET_DIR="/var/packages/$PKG_NAME/target"
UI_DIR="$TARGET_DIR/ui"
VAR_DIR="/var/packages/$PKG_NAME/var"

echo "Post-installation starting for package: $PKG_NAME"
echo "Package destination: $SYNOPKG_PKGDEST"
echo "Target directory: $TARGET_DIR"

# Create VAR directory
mkdir -p "$VAR_DIR" || { echo "Failed to create VAR_DIR: $VAR_DIR"; exit 1; }

# Log function
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$VAR_DIR/install.log" 2>/dev/null || echo "$1"
}

log_message "Post-installation started"

# Create symbolic link for UI
if ln -sf "/var/packages/$PKG_NAME/target/ui" "/usr/syno/synoman/webman/3rdparty/$PKG_NAME" 2>/dev/null; then
    log_message "Created web interface symlink"
else
    log_message "Warning: Failed to create web interface symlink"
fi

# Create and set permission for general log file
touch "$VAR_DIR/$PKG_NAME.log" 2>/dev/null && chmod 644 "$VAR_DIR/$PKG_NAME.log"
log_message "Log file created and permissions set"

log_message "Post-installation completed successfully"
echo "Post-installation completed successfully"

exit 0

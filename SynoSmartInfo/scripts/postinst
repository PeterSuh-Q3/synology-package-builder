#!/bin/bash

PKG_NAME=$(basename "$SYNOPKG_PKGDEST")
TARGET_DIR="/var/packages/$PKG_NAME/target"
UI_DIR="$TARGET_DIR/ui"
VAR_DIR="/var/packages/$PKG_NAME/var"

# Log function
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$VAR_DIR/install.log" 2>/dev/null || echo "$1"
}

log_message "postinst running as user: $(whoami)"
log_message "Post-installation starting for package: $PKG_NAME"

# Create VAR directory
if mkdir -p "$VAR_DIR"; then
    log_message "VAR_DIR created or already exists: $VAR_DIR"
else
    log_message "Failed to create VAR_DIR: $VAR_DIR"
    exit 1
fi

# Create symbolic link for UI
if ln -sf "/var/packages/$PKG_NAME/target/ui" "/usr/syno/synoman/webman/3rdparty/$PKG_NAME" 2>/dev/null; then
    log_message "Created web interface symlink"
else
    log_message "Warning: Failed to create web interface symlink"
fi

# Create result directory in webman (for static file serving)
RESULT_DIR="/usr/syno/synoman/webman/3rdparty/$PKG_NAME/result"
if sudo mkdir -p "$RESULT_DIR"; then
    log_message "Created result directory: $RESULT_DIR"
    sudo chmod 755 "$RESULT_DIR"
else
    log_message "Failed to create result directory: $RESULT_DIR"
fi

# Move syno_smart_info.sh to bin directory if in ui
UI_SCRIPT="$TARGET_DIR/ui/syno_smart_info.sh"
BIN_DIR="$TARGET_DIR/bin"
BIN_SCRIPT="$BIN_DIR/syno_smart_info.sh"

if [ -f "$UI_SCRIPT" ]; then
    mkdir -p "$BIN_DIR"
    mv "$UI_SCRIPT" "$BIN_SCRIPT"
    chmod +x "$BIN_SCRIPT"
    log_message "Moved syno_smart_info.sh to bin directory"
fi

# Create initial SMART result file
if [ -f "$BIN_SCRIPT" ]; then
    RESULT_FILE="$RESULT_DIR/smart.result"
    sudo "$BIN_SCRIPT" > "$RESULT_FILE" 2>&1 || echo "Initial SMART scan failed" > "$RESULT_FILE"
    sudo chmod 644 "$RESULT_FILE"
    log_message "Created initial SMART result file"
fi

GENERATE_SCRIPT="$TARGET_DIR/bin/generate_smart_result.sh"
chmod +x "$GENERATE_SCRIPT"

# 초기 결과 파일 생성
sudo "$GENERATE_SCRIPT"
log_message "Generated initial SMART result"

# postinst에서 결과 생성 스크립트 포함
RESULT_DIR="/usr/syno/synoman/webman/3rdparty/Synosmartinfo/result"
sudo /var/packages/Synosmartinfo/target/bin/syno_smart_info.sh > "$RESULT_DIR/smart.result"

log_message "Post-installation completed successfully"
exit 0

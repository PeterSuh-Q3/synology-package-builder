#!/bin/bash

PKG_NAME=$(basename "$SYNOPKG_PKGDEST")
TARGET_DIR="/var/packages/$PKG_NAME/target"
BIN_DIR="$TARGET_DIR/bin"
VAR_DIR="/var/packages/$PKG_NAME/var"

# 로그 함수
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$VAR_DIR/install.log"
}

# 필요한 디렉터리 생성
mkdir -p "$VAR_DIR"
mkdir -p "$BIN_DIR"

# 서비스 스크립트 복사 (패키지에 포함된 경우)
if [ -f "$SYNOPKG_PKGDEST/bin/change_panel_size.sh" ]; then
    cp "$SYNOPKG_PKGDEST/bin/change_panel_size.sh" "$BIN_DIR/"
    log_message "Copied change_panel_size.sh to $BIN_DIR/"
fi

if [ -f "$SYNOPKG_PKGDEST/bin/storagepanel.sh" ]; then
    cp "$SYNOPKG_PKGDEST/bin/storagepanel.sh" "$BIN_DIR/"
    log_message "Copied storagepanel.sh to $BIN_DIR/"
fi

# 심볼릭 링크 생성 (DSM 웹 인터페이스용)
ln -sf /var/packages/$PKG_NAME/target/ui /usr/syno/synoman/webman/3rdparty/$PKG_NAME

# 서비스 스크립트들 권한 설정
chmod +x "$BIN_DIR/storagepanel.sh" 2>/dev/null || true
chmod +x "$BIN_DIR/change_panel_size.sh" 2>/dev/null || true

# 로그 파일 생성 및 권한 설정
touch "$VAR_DIR/change_panel_size.log"
chmod 644 "$VAR_DIR/change_panel_size.log"

exit 0

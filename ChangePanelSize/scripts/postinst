#!/bin/bash

PKG_NAME=$(basename "$SYNOPKG_PKGDEST")
TARGET_DIR="/var/packages/$PKG_NAME/target"
BIN_DIR="$TARGET_DIR/bin"
VAR_DIR="/var/packages/$PKG_NAME/var"

echo "Post-installation starting for package: $PKG_NAME"
echo "Package destination: $SYNOPKG_PKGDEST"
echo "Target directory: $TARGET_DIR"

mkdir -p "$VAR_DIR" || { echo "Failed to create VAR_DIR: $VAR_DIR"; exit 1; }
mkdir -p "$BIN_DIR" || { echo "Failed to create BIN_DIR: $BIN_DIR"; exit 1; }

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$VAR_DIR/install.log" 2>/dev/null || echo "$1"
}

log_message "Post-installation started"

# 파일 존재 확인 출력 (디버깅용)
log_message "Listing files in $SYNOPKG_PKGDEST/bin:"
ls -l "$SYNOPKG_PKGDEST/bin" 2>/dev/null | tee -a "$VAR_DIR/install.log"

# 파일 복사 및 권한 설정
for script in change_panel_size.sh storagepanel.sh; do
    if [ -f "$SYNOPKG_PKGDEST/bin/$script" ]; then
        cp "$SYNOPKG_PKGDEST/bin/$script" "$BIN_DIR/" && \
        log_message "Copied $script to $BIN_DIR/" || \
        log_message "Failed to copy $script"
        chmod +x "$BIN_DIR/$script" && log_message "Set permissions for $script"
    else
        log_message "Warning: $script not found in package"
    fi
done

# 심볼릭 링크
if ln -sf "$TARGET_DIR/ui" "/usr/syno/synoman/webman/3rdparty/$PKG_NAME" 2>/dev/null; then
    log_message "Created web interface symlink"
else
    log_message "Warning: Failed to create web interface symlink"
fi

# 로그 파일 생성 및 권한 설정
touch "$VAR_DIR/change_panel_size.log" 2>/dev/null && \
chmod 644 "$VAR_DIR/change_panel_size.log" 2>/dev/null && \
log_message "Created and configured log file"

# 서비스 스크립트들 권한 설정
if [ -f "$BIN_DIR/storagepanel.sh" ]; then
    chmod +x "$BIN_DIR/storagepanel.sh"
    log_message "Set permissions for storagepanel.sh"
fi
if [ -f "$BIN_DIR/change_panel_size.sh" ]; then
    chmod +x "$BIN_DIR/change_panel_size.sh"
    log_message "Set permissions for change_panel_size.sh"
fi

log_message "Post-installation completed successfully"
echo "Post-installation completed successfully"

exit 0
